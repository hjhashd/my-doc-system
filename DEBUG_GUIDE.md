# 文档处理系统调试指南

## 问题概述
系统在处理文档时可能出现500错误，主要原因是前端在文档处理完成前就尝试获取文档URL，而后端Python服务可能还在处理中。

## 已实施的解决方案

### 1. 前端状态管理优化
- 添加了轮询机制，定期检查文档处理状态
- 实现了加载状态和错误状态的UI反馈
- 添加了文档处理进度显示

### 2. API错误处理增强
- 增强了onlyoffice-docurl API的错误处理和日志记录
- 改进了对后端服务连接失败的处理
- 添加了更详细的错误信息返回

## 调试步骤

### 1. 检查后端服务状态
```bash
# 检查Python OCR服务是否运行
curl http://localhost:11111/health

# 检查特定任务状态
curl http://localhost:11111/report_status/{taskId}
```

### 2. 检查前端API调用
打开浏览器开发者工具，查看网络请求：
1. 访问文档编辑器页面
2. 检查`/api/onlyoffice-docurl`请求的响应
3. 查看是否有轮询请求及其响应状态

### 3. 检查环境变量
确保以下环境变量已正确设置：
- `PYTHON_OCR_SERVICE_URL`: Python OCR服务的URL
- `NEXT_PUBLIC_BASE_URL`: 前端基础URL
- `NEXT_PUBLIC_DS_BASE_URL`: 文档服务基础URL

### 4. 查看日志
```bash
# 查看Next.js应用日志
npm run dev

# 查看Python服务日志
python test.py
```

## 验证方法

### 1. 正常流程验证
1. 上传一个PDF文件
2. 观察页面是否显示"正在处理文档，请稍候..."
3. 等待处理完成，检查是否自动切换到编辑器视图
4. 验证文档URL是否正确生成

### 2. 错误场景验证
1. 故意提供无效的taskId
2. 检查是否显示适当的错误信息
3. 验证是否有"重新加载"按钮
4. 测试重新加载功能是否正常

### 3. 超时场景验证
1. 上传一个大文件，可能导致处理时间较长
2. 验证轮询机制是否正常工作
3. 检查是否在最大轮询次数后显示超时错误

## 常见问题及解决方案

### 问题1: 连接后端服务失败
**症状**: 前端显示"连接后端服务失败"
**解决方案**: 
1. 检查Python OCR服务是否正在运行
2. 验证PYTHON_OCR_SERVICE_URL环境变量是否正确
3. 检查防火墙设置

### 问题2: 文档URL构建失败
**症状**: 文档处理完成但无法显示
**解决方案**:
1. 检查NEXT_PUBLIC_BASE_URL和NEXT_PUBLIC_DS_BASE_URL环境变量
2. 验证文档存储路径是否正确
3. 检查文件权限

### 问题3: 轮询不停止
**症状**: 页面一直显示"正在处理文档"
**解决方案**:
1. 检查后端是否正确返回处理完成状态
2. 验证前端轮询逻辑是否正确处理响应
3. 检查最大轮询次数设置

## 性能优化建议

1. **调整轮询间隔**: 根据文档处理平均时间调整轮询间隔
2. **实现WebSocket**: 对于实时性要求高的场景，考虑使用WebSocket替代轮询
3. **添加缓存**: 对已处理的文档URL进行缓存，减少重复请求

## 日志分析

### 后端日志关键点
- `正在查询任务状态`: API调用开始
- `任务状态响应`: 后端响应内容
- `文档URL构建成功`: 成功状态
- `连接后端服务失败`: 连接错误

### 前端日志关键点
- `轮询文档URL失败`: 网络请求问题
- `获取文档URL失败`: 整体流程失败
- 状态变化: 加载→处理中→完成/错误

## 联系支持
如果问题仍然存在，请收集以下信息:
1. 浏览器控制台错误日志
2. 网络请求详情
3. 后端服务日志
4. 复现步骤

将这些信息提供给开发团队以便进一步诊断。